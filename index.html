<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>D&D Session Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCo1UDoLEKLyK0xGUS3SPp-Pl7h6M2viq8",
      authDomain: "dnd-session-manager-5a6fa.firebaseapp.com",
      databaseURL: "https://dnd-session-manager-5a6fa-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dnd-session-manager-5a6fa",
      storageBucket: "dnd-session-manager-5a6fa.appspot.com",
      messagingSenderId: "289433942788",
      appId: "1:289433942788:web:1cd3bc91f08e2ab838ee51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.dndApp = { db, ref, set, onValue, get, update };
  </script>
</head>
<body>
  <h1>D&D Session Manager</h1>

  <div id="discord-login" class="section">
    <h2>Login with Discord</h2>
    <button onclick="loginWithDiscord()">Login</button>
  </div>

  <div id="dashboard-section" class="section hidden">
    <h2>Welcome, <span id="user-name"></span>!</h2>
    <img id="avatar" src="" width="64" height="64" style="border-radius: 50%; margin: 10px auto; display: block;" />
    <button onclick="createSession()">üé≤ Create New Session</button>
    <h3>Or join a session:</h3>
    <input type="text" id="session-id-input" placeholder="Enter Session Name" />
    <button onclick="joinSession()">Join Session</button>
    <h3>My Sessions:</h3>
    <div id="session-list"></div>
  </div>

  <div id="session-view" class="section hidden">
    <h2>Session: <span id="view-session-name"></span></h2>
    <div id="view-role"></div>
    <div id="session-details"></div>
    <button onclick="backToDashboard()">Back</button>
  </div>

  <script>
    let nickname = "";
    let userId = "";

    function loginWithDiscord() {
      const clientId = "1394705358873690355";
      const redirectUri = encodeURIComponent("https://jerichophy.github.io/DnDNotifier/");
      const scope = "identify";
      const responseType = "token";
      const discordAuthUrl = `https://discord.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=${responseType}&scope=${scope}`;
      window.location.href = discordAuthUrl;
    }

    async function getUserInfoFromDiscord(token) {
      const response = await fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `Bearer ${token}` }
      });
      return await response.json();
    }

    async function handleDiscordLogin() {
      const hash = window.location.hash;
      if (!hash.includes("access_token")) return;

      const params = new URLSearchParams(hash.slice(1));
      const token = params.get("access_token");
      if (!token) return;

      const user = await getUserInfoFromDiscord(token);
      nickname = `${user.username}#${user.discriminator}`;
      userId = user.id;

      document.getElementById("user-name").textContent = nickname;
      document.getElementById("avatar").src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
      document.getElementById("discord-login").classList.add("hidden");
      document.getElementById("dashboard-section").classList.remove("hidden");

      loadUserSessions();
    }

    function createSession() {
      const name = prompt("Name your session (e.g. 'curse-of-strahd')")?.toLowerCase().replace(/\s+/g, "-");
      if (!name) return;

      const { db, ref, set, get } = window.dndApp;
      const sessionRef = ref(db, `sessions/${name}`);

      get(sessionRef).then((snapshot) => {
        if (snapshot.exists()) {
          alert("Session name already exists. Choose another.");
        } else {
          set(sessionRef, {
            dm: { username: nickname, id: userId },
            sessionLocked: false
          }).then(() => {
            alert(`Session '${name}' created.`);
            loadUserSessions();
          });
        }
      });
    }

    function joinSession() {
      const name = document.getElementById("session-id-input").value.trim().toLowerCase();
      if (!name) return;

      const { db, ref, set, get } = window.dndApp;
      const sessionRef = ref(db, `sessions/${name}`);
      const pendingRef = ref(db, `sessions/${name}/pendingPlayers/${userId}`);
      const approvedRef = ref(db, `sessions/${name}/approvedPlayers/${userId}`);

      get(sessionRef).then((snapshot) => {
        if (!snapshot.exists()) return alert("That session does not exist.");
        const session = snapshot.val();
        if (session.sessionLocked) return alert("This session is locked. No new players can join.");

        get(approvedRef).then((approvedSnap) => {
          if (approvedSnap.exists()) return alert("You are already approved for this session.");

          get(pendingRef).then((pendingSnap) => {
            if (pendingSnap.exists()) {
              if (confirm("You're already in the pending list. Cancel your join request?")) {
                set(pendingRef, null).then(() => alert("Request cancelled."));
              }
              return;
            }

            const readyAt = prompt("What time are you ready? (HH:MM)");
            const waitUntil = prompt("How long will you wait? (HH:MM)");
            if (!readyAt || !waitUntil) return;

            set(pendingRef, { name: nickname, readyAt, waitUntil }).then(() => {
              alert("Join request sent. Awaiting DM approval.");
              loadUserSessions();
            });
          });
        });
      });
    }

    function loadUserSessions() {
      const { db, ref, get } = window.dndApp;
      const sessionList = document.getElementById("session-list");
      sessionList.innerHTML = "Loading...";

      get(ref(db, "sessions")).then((snapshot) => {
        const sessions = snapshot.val();
        sessionList.innerHTML = "";
        if (!sessions) return (sessionList.innerHTML = "<i>No sessions found.</i>");

        Object.entries(sessions).forEach(([sessionName, session]) => {
          let role = "";
          let isIn = false;
          if (session.dm?.id === userId) {
            role = "DM"; isIn = true;
          } else if (session.approvedPlayers?.[userId]) {
            role = "Player"; isIn = true;
          } else if (session.pendingPlayers?.[userId]) {
            role = "Pending"; isIn = true;
          }

          if (isIn) {
            const div = document.createElement("div");
            div.innerHTML = `<strong>${sessionName}</strong> (${role}) 
              <button onclick="viewSession('${sessionName}', '${role}')">View</button>
              ${role === "DM" ? `<button onclick="deleteSession('${sessionName}')">Delete</button>` : ""}`;
            sessionList.appendChild(div);
          }
        });
      });
    }

    function viewSession(name, role) {
      document.getElementById("dashboard-section").classList.add("hidden");
      document.getElementById("session-view").classList.remove("hidden");
      document.getElementById("view-session-name").textContent = name;
      document.getElementById("view-role").textContent = `You are the ${role}`;

      const container = document.getElementById("session-details");
      container.innerHTML = `<div id="lock-status"></div><div id="lock-control"></div>`;

      const { db, ref, onValue } = window.dndApp;
      const approvedRef = ref(db, `sessions/${name}/approvedPlayers`);
      const pendingRef = ref(db, `sessions/${name}/pendingPlayers`);
      const sessionRef = ref(db, `sessions/${name}`);

      onValue(sessionRef, (snapshot) => {
        const session = snapshot.val();
        const lockedText = session.sessionLocked ? "üîí Locked" : "üîì Unlocked";
        document.getElementById("lock-status").textContent = `Session is currently ${lockedText}`;

        const lockBtn = session.sessionLocked
          ? `<button onclick="unlockSession('${name}')">üîì Unlock Session</button>`
          : `<button onclick="lockSession('${name}')">üîí Done (Lock Session)</button>`;

        document.getElementById("lock-control").innerHTML = lockBtn;
      });

      onValue(approvedRef, (snapshot) => {
        const data = snapshot.val() || {};
        let html = "<h3>Approved Players</h3>";
        html += Object.entries(data).length
          ? "<ul>" + Object.values(data).map(p => `<li><strong>${p.name}</strong>: Ready At ${p.readyAt}, Wait Until ${p.waitUntil}</li>`).join("") + "</ul>"
          : "<i>No approved players yet.</i>";
        container.innerHTML += html;
      });

      if (role === "DM") {
        onValue(pendingRef, (snapshot) => {
          const data = snapshot.val() || {};
          let html = "<h3>Pending Players</h3>";
          html += Object.entries(data).length
            ? "<ul>" + Object.entries(data).map(([id, p]) => `<li><strong>${p.name}</strong>: Ready At ${p.readyAt}, Wait Until ${p.waitUntil} <button onclick=\"approvePlayer('${name}','${id}')\">‚úÖ Approve</button> <button onclick=\"rejectPlayer('${name}','${id}')\">‚ùå Reject</button></li>`).join("") + "</ul>"
            : "<i>No pending players.</i>";
          container.innerHTML += html;
        });
      }
    }

    function lockSession(name) {
      const { db, ref, update } = window.dndApp;
      update(ref(db, `sessions/${name}`), { sessionLocked: true });
    }

    function unlockSession(name) {
      const { db, ref, update } = window.dndApp;
      update(ref(db, `sessions/${name}`), { sessionLocked: false });
    }

    function approvePlayer(session, playerId) {
      const { db, ref, get, set } = window.dndApp;
      const from = ref(db, `sessions/${session}/pendingPlayers/${playerId}`);
      const to = ref(db, `sessions/${session}/approvedPlayers/${playerId}`);
      get(from).then(snap => {
        if (!snap.exists()) return;
        const data = snap.val();
        set(to, data).then(() => set(from, null));
      });
    }

    function rejectPlayer(session, playerId) {
      const { db, ref, set } = window.dndApp;
      set(ref(db, `sessions/${session}/pendingPlayers/${playerId}`), null);
    }

    function deleteSession(sessionName) {
      if (!confirm(`Are you sure you want to DELETE session '${sessionName}'?`)) return;
      const { db, ref, set } = window.dndApp;
      set(ref(db, `sessions/${sessionName}`), null).then(() => {
        alert("Session deleted.");
        loadUserSessions();
        backToDashboard();
      });
    }

    function backToDashboard() {
      document.getElementById("session-view").classList.add("hidden");
      document.getElementById("dashboard-section").classList.remove("hidden");
      loadUserSessions();
    }

    window.onload = handleDiscordLogin;
  </script>
</body>
</html>

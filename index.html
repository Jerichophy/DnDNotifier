<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>D&D Session Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCo1UDoLEKLyK0xGUS3SPp-Pl7h6M2viq8",
      authDomain: "dnd-session-manager-5a6fa.firebaseapp.com",
      databaseURL: "https://dnd-session-manager-5a6fa-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dnd-session-manager-5a6fa",
      storageBucket: "dnd-session-manager-5a6fa.appspot.com",
      messagingSenderId: "289433942788",
      appId: "1:289433942788:web:1cd3bc91f08e2ab838ee51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.dndApp = { db, ref, set, onValue, get, update };
  </script>
</head>
<body>
  <h1>D&D Session Manager</h1>

  <div id="discord-login" class="section">
    <h2>Login with Discord</h2>
    <button onclick="loginWithDiscord()">Login</button>
  </div>

  <div id="dashboard-section" class="section hidden">
    <h2>Welcome, <span id="user-name"></span>!</h2>
    <img id="avatar" src="" width="64" height="64" style="border-radius: 50%; margin: 10px auto;" />
    <button onclick="createSession()">üé≤ Create New Session</button>
    <h3>Or join a session:</h3>
    <input type="text" id="session-id-input" placeholder="Enter Session Name" />
    <button onclick="joinSession()">Join Session</button>
    <h3>My Sessions:</h3>
    <div id="session-list"></div>
  </div>

  <div id="session-view" class="section hidden">
    <h2>Session: <span id="view-session-name"></span></h2>
    <div id="view-role"></div>
    <div id="session-details"></div>
    <button onclick="backToDashboard()">Back</button>
  </div>

  <script>
    const webhookUrl = "https://discord.com/api/webhooks/1394696085494169690/7ZOhUsbaArmsYVsRD6U9FUXSNK5k69KZSJ874-ldmEB_mmdwu0e5nXXoqQSTsLI9FUlu";
    let nickname = "", userId = "";

    async function sendDiscordNotification(message) {
      try {
        await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: message })
        });
      } catch (err) {
        console.warn("Failed to send Discord notification:", err);
      }
    }

    function loginWithDiscord() {
      const clientId = "1394705358873690355";
      const redirectUri = encodeURIComponent("https://jerichophy.github.io/DnDNotifier/");
      const scope = "identify";
      const discordAuthUrl = `https://discord.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=${scope}`;
      window.location.href = discordAuthUrl;
    }

    async function getUserInfoFromDiscord(token) {
      const res = await fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `Bearer ${token}` }
      });
      return await res.json();
    }

    async function handleDiscordLogin() {
      const hash = window.location.hash;
      if (!hash.includes("access_token")) return;
      const token = new URLSearchParams(hash.slice(1)).get("access_token");
      if (!token) return;

      const user = await getUserInfoFromDiscord(token);
      nickname = `${user.username}#${user.discriminator}`;
      userId = user.id;

      document.getElementById("user-name").textContent = nickname;
      document.getElementById("avatar").src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
      document.getElementById("discord-login").classList.add("hidden");
      document.getElementById("dashboard-section").classList.remove("hidden");

      loadUserSessions();
    }

    function backToDashboard() {
      document.getElementById("session-view").classList.add("hidden");
      document.getElementById("dashboard-section").classList.remove("hidden");
    }

    function createSession() {
      const name = prompt("Enter a name for your session:")?.toLowerCase().replace(/\s+/g, "-");
      if (!name) return;

      const { db, ref, set, get } = window.dndApp;
      const sessionRef = ref(db, `sessions/${name}`);

      get(sessionRef).then(snap => {
        if (snap.exists()) {
          alert("That session already exists.");
          return;
        }

        set(sessionRef, {
          dm: { username: nickname, id: userId },
          sessionLocked: false
        }).then(() => {
          alert(`Session '${name}' created.`);
          loadUserSessions();
        });
      });
    }

    function joinSession() {
      const name = document.getElementById("session-id-input").value.trim().toLowerCase();
      if (!name) return;

      const { db, ref, set, get } = window.dndApp;
      const sessionRef = ref(db, `sessions/${name}`);
      const pendingRef = ref(db, `sessions/${name}/pendingPlayers/${userId}`);
      const approvedRef = ref(db, `sessions/${name}/approvedPlayers/${userId}`);

      get(sessionRef).then(snapshot => {
        if (!snapshot.exists()) return alert("Session not found.");

        const session = snapshot.val();
        if (session.sessionLocked) return alert("Session is locked.");

        get(approvedRef).then(ap => {
          if (ap.exists()) return alert("You're already in this session.");
          get(pendingRef).then(pp => {
            if (pp.exists()) {
              if (confirm("Cancel existing join request?")) {
                set(pendingRef, null).then(() => alert("Cancelled."));
              }
              return;
            }

            const readyAt = prompt("When are you ready? (HH:MM)");
            const waitUntil = prompt("Until what time can you wait? (HH:MM)");
            if (!readyAt || !waitUntil) return;

            set(pendingRef, {
              name: nickname, readyAt, waitUntil
            }).then(() => {
              sendDiscordNotification(`üé≤ ${nickname} requested to join '${name}' ‚Äî Ready At ${readyAt}, Wait Until ${waitUntil}`);
              alert("Request sent.");
            });
          });
        });
      });
    }

    function loadUserSessions() {
      const { db, ref, get } = window.dndApp;
      const container = document.getElementById("session-list");
      container.innerHTML = "Loading...";

      get(ref(db, "sessions")).then(snapshot => {
        const sessions = snapshot.val();
        container.innerHTML = "";

        if (!sessions) return container.innerHTML = "<i>No sessions found</i>";

        Object.entries(sessions).forEach(([name, session]) => {
          let role = "", inSession = false;

          if (session.dm?.id === userId) {
            role = "DM"; inSession = true;
          } else if (session.approvedPlayers?.[userId]) {
            role = "Player"; inSession = true;
          } else if (session.pendingPlayers?.[userId]) {
            role = "Pending"; inSession = true;
          }

          if (inSession) {
            const div = document.createElement("div");
            div.innerHTML = `<strong>${name}</strong> (${role})
              <button onclick="viewSession('${name}', '${role}')">View</button>`;
            container.appendChild(div);
          }
        });
      });
    }

    function lockSession(sessionName) {
      const { db, ref, get, update } = window.dndApp;
      const approvedRef = ref(db, `sessions/${sessionName}/approvedPlayers`);

      get(approvedRef).then(snapshot => {
        const players = snapshot.val();
        if (!players) return alert("No approved players yet.");

        const latest = Object.values(players).reduce((max, p) => {
          return (!p.readyAt || p.readyAt < max) ? max : p.readyAt;
        }, "00:00");

        update(ref(db, `sessions/${sessionName}`), {
          sessionLocked: true,
          sessionStartTime: latest
        }).then(() => {
          alert(`Session locked. Start time: ${latest}`);
          sendDiscordNotification(`üîí '${sessionName}' locked.\nüïí Starts at **${latest}**`);
        });
      });
    }

    function approvePlayer(session, id) {
      const { db, ref, get, set } = window.dndApp;
      const pendRef = ref(db, `sessions/${session}/pendingPlayers/${id}`);
      const apprRef = ref(db, `sessions/${session}/approvedPlayers/${id}`);

      get(pendRef).then(snapshot => {
        if (!snapshot.exists()) return;
        const player = snapshot.val();
        set(apprRef, player).then(() => {
          set(pendRef, null);
          sendDiscordNotification(`‚úÖ ${player.name} approved for '${session}'`);
        });
      });
    }

    function rejectPlayer(session, id) {
      const { db, ref, set } = window.dndApp;
      set(ref(db, `sessions/${session}/pendingPlayers/${id}`), null).then(() => {
        sendDiscordNotification(`‚ùå Rejected a player from '${session}'`);
      });
    }

    function viewSession(name, role) {
      document.getElementById("dashboard-section").classList.add("hidden");
      document.getElementById("session-view").classList.remove("hidden");
      document.getElementById("view-session-name").textContent = name;
      document.getElementById("view-role").textContent = `You are the ${role}`;
      const container = document.getElementById("session-details");
      container.innerHTML = "";

      const { db, ref, get, onValue, update } = window.dndApp;
      const sessionRef = ref(db, `sessions/${name}`);

      get(sessionRef).then(snapshot => {
        const session = snapshot.val();
        if (session?.sessionStartTime) {
          const p = document.createElement("p");
          p.innerHTML = `<strong>Session Start Time:</strong> ${session.sessionStartTime}`;
          container.prepend(p);
        }
      });

      const approvedRef = ref(db, `sessions/${name}/approvedPlayers`);
      const pendingRef = ref(db, `sessions/${name}/pendingPlayers`);

      onValue(approvedRef, snap => {
        const data = snap.val() || {};
        let html = "<h3>Approved Players</h3>";
        html += Object.keys(data).length
          ? "<ul>" + Object.entries(data).map(([_, p]) =>
              `<li><strong>${p.name}</strong>: Ready At ${p.readyAt}, Wait Until ${p.waitUntil}</li>`).join("") + "</ul>"
          : "<i>No approved players</i>";
        container.innerHTML += html;

        if (role === "Player" && data[userId] && (!data[userId].readyAt || !data[userId].waitUntil)) {
          const newReadyAt = prompt("Enter new Ready At time (HH:MM)");
          const newWaitUntil = prompt("Enter new Wait Until time (HH:MM)");
          if (newReadyAt && newWaitUntil) {
            update(ref(db, `sessions/${name}/approvedPlayers/${userId}`), {
              readyAt: newReadyAt,
              waitUntil: newWaitUntil
            });
            sendDiscordNotification(`üïí ${nickname} updated availability ‚Äî ${newReadyAt} to ${newWaitUntil}`);
          }
        }
      });

      if (role === "DM") {
        onValue(pendingRef, snap => {
          const data = snap.val() || {};
          let html = "<h3>Pending Players</h3>";
          html += Object.keys(data).length
            ? "<ul>" + Object.entries(data).map(([id, p]) =>
                `<li><strong>${p.name}</strong>: Ready At ${p.readyAt}, Wait Until ${p.waitUntil}
                  <button onclick="approvePlayer('${name}', '${id}')">‚úÖ Approve</button>
                  <button onclick="rejectPlayer('${name}', '${id}')">‚ùå Reject</button></li>`).join("") + "</ul>"
            : "<i>No pending players</i>";
          container.innerHTML += html;

          container.innerHTML += `<button onclick="lockSession('${name}')">üîí Lock Session</button>`;
        });
      }
    }

    window.onload = handleDiscordLogin;
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D&D Session Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCo1UDoLEKLyK0xGUS3SPp-Pl7h6M2viq8",
      authDomain: "dnd-session-manager-5a6fa.firebaseapp.com",
      databaseURL: "https://dnd-session-manager-5a6fa-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dnd-session-manager-5a6fa",
      storageBucket: "dnd-session-manager-5a6fa.appspot.com",
      messagingSenderId: "289433942788",
      appId: "1:289433942788:web:1cd3bc91f08e2ab838ee51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.dndApp = { db, ref, push, set, onValue };
  </script>
</head>
<body>
  <h1>D&D Session Manager</h1>

  <!-- Discord Login -->
  <div id="discord-login" class="section">
    <h2>Login with Discord</h2>
    <button onclick="loginWithDiscord()">Login</button>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboard-section" class="section hidden">
    <h2>Welcome, <span id="user-name"></span>!</h2>
    <img id="avatar" src="" width="64" height="64" style="border-radius: 50%; margin: 10px auto; display:block;">
    <button onclick="createSession()">ðŸŽ² Create New Session</button>
    <h3>Or join a session:</h3>
    <input type="text" id="session-id-input" placeholder="Enter Session ID">
    <button onclick="joinSession()">Join Session</button>
  </div>

  <!-- Player Form -->
  <div id="player-section" class="section hidden">
    <h2>Join Session: <span id="session-code-display"></span></h2>
    <label>Ready At:</label>
    <input type="time" id="readyAt">
    <label>Wait Until:</label>
    <input type="time" id="waitUntil">
    <button onclick="submitAvailability()">I'm Ready</button>
  </div>

  <!-- DM View -->
  <div id="dm-section" class="section hidden">
    <h2>DM Panel â€“ Session ID: <span id="dm-session-code"></span></h2>
    <div id="players-list"></div>
  </div>

  <script>
    let nickname = "";
    let sessionId = "";
    let isDM = false;

    function loginWithDiscord() {
      const clientId = "1394705358873690355";
      const redirectUri = encodeURIComponent("https://jerichophy.github.io/DnDNotifier/");
      const scope = "identify";
      const responseType = "token";

      const discordAuthUrl = `https://discord.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=${responseType}&scope=${scope}`;
      window.location.href = discordAuthUrl;
    }

    async function getUserInfoFromDiscord(token) {
      const response = await fetch("https://discord.com/api/users/@me", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      return await response.json();
    }

    async function handleDiscordLogin() {
      const hash = window.location.hash;
      if (!hash.includes("access_token")) return;

      const params = new URLSearchParams(hash.slice(1));
      const token = params.get("access_token");

      if (token) {
        const user = await getUserInfoFromDiscord(token);
        nickname = `${user.username}#${user.discriminator}`;
        window.discordUser = {
          id: user.id,
          username: user.username,
          discriminator: user.discriminator,
          avatar: user.avatar
        };

        document.getElementById("user-name").textContent = nickname;
        document.getElementById("avatar").src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has("session")) {
          const sessionId = urlParams.get("session");
          checkIfUserIsDM(sessionId, user.id);
        } else {
          document.getElementById("discord-login").classList.add("hidden");
          document.getElementById("dashboard-section").classList.remove("hidden");
        }
      }
    }

    function createSession() {
      const { db, ref, push, set } = window.dndApp;
      const sessionRef = push(ref(db, "sessions"));
      sessionId = sessionRef.key;
      set(sessionRef, {
        dm: {
          username: nickname,
          id: window.discordUser.id
        }
      });

      isDM = true;
      document.getElementById("dashboard-section").classList.add("hidden");
      document.getElementById("dm-section").classList.remove("hidden");
      document.getElementById("dm-session-code").textContent = sessionId;

      listenToPlayers();
    }

    function joinSession() {
      const input = document.getElementById("session-id-input").value.trim();
      if (!input) return alert("Enter a session ID.");
      sessionId = input;
      document.getElementById("dashboard-section").classList.add("hidden");
      document.getElementById("player-section").classList.remove("hidden");
      document.getElementById("session-code-display").textContent = sessionId;
    }

    function submitAvailability() {
      const readyAt = document.getElementById("readyAt").value;
      const waitUntil = document.getElementById("waitUntil").value;
      if (!readyAt || !waitUntil) return alert("Select both time fields.");

      const { db, ref, push, set } = window.dndApp;
      const playerRef = push(ref(db, `sessions/${sessionId}/players`));
      set(playerRef, {
        name: nickname,
        readyAt,
        waitUntil
      });

      alert("âœ… You're marked as ready!");
      document.getElementById("player-section").classList.add("hidden");
    }

    function listenToPlayers() {
      const { db, ref, onValue } = window.dndApp;
      const playersRef = ref(db, `sessions/${sessionId}/players`);
      onValue(playersRef, snapshot => {
        const data = snapshot.val();
        const container = document.getElementById("players-list");
        container.innerHTML = "";

        if (!data) {
          container.innerHTML = "<i>No players yet.</i>";
          return;
        }

        Object.values(data).forEach(player => {
          const row = document.createElement("div");
          row.className = "player-row";
          row.innerHTML = `
            <strong>${player.name}</strong><br>
            Ready At: ${player.readyAt} | Wait Until: ${player.waitUntil}
          `;
          container.appendChild(row);
        });
      });
    }

    function checkIfUserIsDM(sessionIdFromURL, userId) {
      const { db, ref, onValue } = window.dndApp;
      const dmRef = ref(db, `sessions/${sessionIdFromURL}/dm`);

      onValue(dmRef, snapshot => {
        const dm = snapshot.val();
        if (dm && dm.id === userId) {
          // You are the DM
          sessionId = sessionIdFromURL;
          isDM = true;
          document.getElementById("discord-login").classList.add("hidden");
          document.getElementById("dm-section").classList.remove("hidden");
          document.getElementById("dm-session-code").textContent = sessionId;
          listenToPlayers();
        } else {
          // You are a player
          sessionId = sessionIdFromURL;
          document.getElementById("discord-login").classList.add("hidden");
          document.getElementById("player-section").classList.remove("hidden");
          document.getElementById("session-code-display").textContent = sessionId;
        }
      });
    }

    handleDiscordLogin();
  </script>
</body>
</html>

<!-- Full HTML file -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>D&D Session Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCo1UDoLEKLyK0xGUS3SPp-Pl7h6M2viq8",
      authDomain: "dnd-session-manager-5a6fa.firebaseapp.com",
      databaseURL: "https://dnd-session-manager-5a6fa-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dnd-session-manager-5a6fa",
      storageBucket: "dnd-session-manager-5a6fa.appspot.com",
      messagingSenderId: "289433942788",
      appId: "1:289433942788:web:1cd3bc91f08e2ab838ee51"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    window.dndApp = { db, ref, set, onValue, get, update, remove };
  </script>
</head>
<body>
  <h1>D&D Session Manager</h1>

  <div id="discord-login" class="section">
    <h2>Login with Discord</h2>
    <button onclick="loginWithDiscord()">Login</button>
  </div>

  <div id="dashboard-section" class="section hidden">
    <h2>Welcome, <span id="user-name"></span>!</h2>
    <img id="avatar" src="" width="64" height="64" style="border-radius: 50%; margin: 10px auto;" />
    <button onclick="createSession()">üé≤ Create New Session</button>
    <h3>Or join a session:</h3>
    <input type="text" id="session-id-input" placeholder="Enter Session Name" />
    <button onclick="joinSession()">Join Session</button>
    <h3>My Sessions:</h3>
    <div id="session-list"></div>
  </div>

  <div id="session-view" class="section hidden">
    <h2>Session: <span id="view-session-name"></span></h2>
    <div id="view-role"></div>
    <div id="session-details"></div>
    <button onclick="backToDashboard()">Back</button>
  </div>

  <script>
    const webhookUrl = "https://discord.com/api/webhooks/1394696085494169690/7ZOhUsbaArmsYVsRD6U9FUXSNK5k69KZSJ874-ldmEB_mmdwu0e5nXXoqQSTsLI9FUlu";

    async function sendDiscordNotification(message) {
      try {
        await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: message })
        });
      } catch (err) {
        console.warn("Failed to send Discord notification:", err);
      }
    }

    let nickname = "";
    let userId = "";

    function loginWithDiscord() {
      const clientId = "1394705358873690355";
      const redirectUri = encodeURIComponent("https://jerichophy.github.io/DnDNotifier/");
      const scope = "identify";
      const responseType = "token";
      const discordAuthUrl = `https://discord.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=${responseType}&scope=${scope}`;
      window.location.href = discordAuthUrl;
    }

    async function getUserInfoFromDiscord(token) {
      const response = await fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `Bearer ${token}` }
      });
      return await response.json();
    }

    async function handleDiscordLogin() {
      const hash = window.location.hash;
      if (!hash.includes("access_token")) return;

      const params = new URLSearchParams(hash.slice(1));
      const token = params.get("access_token");
      if (!token) return;

      const user = await getUserInfoFromDiscord(token);
      nickname = `${user.username}#${user.discriminator}`;
      userId = user.id;

      document.getElementById("user-name").textContent = nickname;
      document.getElementById("avatar").src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
      document.getElementById("discord-login").classList.add("hidden");
      document.getElementById("dashboard-section").classList.remove("hidden");

      loadUserSessions();
    }

    function createSession() {
      const name = prompt("Name your session (e.g. 'curse-of-strahd')")?.toLowerCase().replace(/\s+/g, "-");
      if (!name) return;

      const { db, ref, get, set } = window.dndApp;
      const sessionRef = ref(db, `sessions/${name}`);

      get(sessionRef).then((snapshot) => {
        if (snapshot.exists()) {
          alert("Session name already exists.");
        } else {
          set(sessionRef, {
            dm: { username: nickname, id: userId },
            sessionLocked: false
          }).then(() => {
            sendDiscordNotification(`üé≤ Session '${name}' created by ${nickname}`);
            alert("Session created.");
            loadUserSessions();
          });
        }
      });
    }

    function joinSession() {
      const name = document.getElementById("session-id-input").value.trim().toLowerCase();
      if (!name) return;

      const { db, ref, get, set } = window.dndApp;
      const sessionRef = ref(db, `sessions/${name}`);
      const pendingRef = ref(db, `sessions/${name}/pendingPlayers/${userId}`);
      const approvedRef = ref(db, `sessions/${name}/approvedPlayers/${userId}`);

      get(sessionRef).then((snap) => {
        if (!snap.exists()) return alert("That session doesn't exist.");
        if (snap.val().sessionLocked) return alert("This session is locked.");

        get(approvedRef).then((ap) => {
          if (ap.exists()) return alert("You're already in this session.");

          get(pendingRef).then((pp) => {
            if (pp.exists()) {
              if (confirm("Already requested. Cancel request?")) {
                set(pendingRef, null).then(() => {
                  alert("Request cancelled.");
                  loadUserSessions();
                });
              }
            } else {
              const readyAt = prompt("What time are you ready? (HH:MM)");
              const waitUntil = prompt("How long will you wait? (HH:MM)");
              if (!readyAt || !waitUntil) return;

              set(pendingRef, { name: nickname, readyAt, waitUntil }).then(() => {
                sendDiscordNotification(`üé≤ ${nickname} requested to join '${name}' ‚Äî Ready At ${readyAt}, Wait Until ${waitUntil}`);
                alert("Request sent.");
                loadUserSessions();
              });
            }
          });
        });
      });
    }

    function lockSession(name) {
      const { db, ref, get, update } = window.dndApp;
      const approvedRef = ref(db, `sessions/${name}/approvedPlayers`);

      get(approvedRef).then((snapshot) => {
        if (!snapshot.exists()) return alert("No approved players.");

        const players = snapshot.val();
        const times = Object.values(players).map(p => p.readyAt).filter(Boolean);
        if (!times.length) return alert("No times found.");

        const latest = times.reduce((a, b) => (a > b ? a : b));
        update(ref(db, `sessions/${name}`), { sessionLocked: true, sessionStartTime: latest }).then(() => {
          sendDiscordNotification(`üîí Session '${name}' is now locked. Start Time: **${latest}**`);
          viewSession(name, "DM");
        });
      });
    }

    function unlockSession(name) {
      const { db, ref, update } = window.dndApp;
      update(ref(db, `sessions/${name}`), { sessionLocked: false, sessionStartTime: null }).then(() => {
        sendDiscordNotification(`üîì Session '${name}' has been unlocked.`);
        viewSession(name, "DM");
      });
    }

    function deleteSession(name) {
      const { db, ref, remove } = window.dndApp;
      if (confirm(`Delete session '${name}'?`)) {
        remove(ref(db, `sessions/${name}`)).then(() => {
          sendDiscordNotification(`üóëÔ∏è Session '${name}' deleted.`);
          loadUserSessions();
          backToDashboard();
        });
      }
    }

    function viewSession(name, role) {
      document.getElementById("dashboard-section").classList.add("hidden");
      document.getElementById("session-view").classList.remove("hidden");
      document.getElementById("view-session-name").textContent = name;
      document.getElementById("view-role").textContent = `You are the ${role}`;
      const container = document.getElementById("session-details");
      container.innerHTML = "";

      const { db, ref, get, onValue } = window.dndApp;
      get(ref(db, `sessions/${name}`)).then((snap) => {
        const session = snap.val();
        if (session.sessionStartTime) {
          container.innerHTML += `<p><strong>Start Time:</strong> ${session.sessionStartTime}</p>`;
        }

        if (role === "DM") {
          container.innerHTML += session.sessionLocked
            ? `<button onclick="unlockSession('${name}')">üîì Unlock Session</button>`
            : `<button onclick="lockSession('${name}')">üîí Lock Session</button>`;
          container.innerHTML += `<button onclick="deleteSession('${name}')">üóëÔ∏è Delete Session</button>`;
        }
      });

      onValue(ref(db, `sessions/${name}/approvedPlayers`), (snap) => {
        const data = snap.val() || {};
        container.innerHTML += "<h3>Approved Players</h3>" + (
          Object.keys(data).length
            ? "<ul>" + Object.values(data).map(p => `<li>${p.name}: Ready At ${p.readyAt}, Wait Until ${p.waitUntil}</li>`).join("") + "</ul>"
            : "<i>No approved players yet.</i>"
        );
      });

      if (role === "DM") {
        onValue(ref(db, `sessions/${name}/pendingPlayers`), (snap) => {
          const data = snap.val() || {};
          container.innerHTML += "<h3>Pending Players</h3>" + (
            Object.keys(data).length
              ? "<ul>" + Object.entries(data).map(([id, p]) => `<li>${p.name}: Ready At ${p.readyAt}, Wait Until ${p.waitUntil} 
              <button onclick="approvePlayer('${name}', '${id}')">‚úÖ</button>
              <button onclick="rejectPlayer('${name}', '${id}')">‚ùå</button></li>`).join("") + "</ul>"
              : "<i>No pending players.</i>"
          );
        });
      }
    }

    function backToDashboard() {
      document.getElementById("session-view").classList.add("hidden");
      document.getElementById("dashboard-section").classList.remove("hidden");
      loadUserSessions();
    }

    function approvePlayer(name, id) {
      const { db, ref, get, set } = window.dndApp;
      const pRef = ref(db, `sessions/${name}/pendingPlayers/${id}`);
      const aRef = ref(db, `sessions/${name}/approvedPlayers/${id}`);
      get(pRef).then(snap => {
        if (!snap.exists()) return;
        const p = snap.val();
        set(aRef, p).then(() => {
          set(pRef, null);
          sendDiscordNotification(`‚úÖ ${p.name} approved for '${name}'`);
          viewSession(name, "DM");
        });
      });
    }

    function rejectPlayer(name, id) {
      const { db, ref, remove } = window.dndApp;
      remove(ref(db, `sessions/${name}/pendingPlayers/${id}`)).then(() => {
        sendDiscordNotification(`‚ùå A player was rejected from '${name}'`);
        viewSession(name, "DM");
      });
    }

    function loadUserSessions() {
      const { db, ref, get } = window.dndApp;
      const sessionList = document.getElementById("session-list");
      sessionList.innerHTML = "Loading...";

      get(ref(db, "sessions")).then((snap) => {
        const sessions = snap.val();
        sessionList.innerHTML = "";
        if (!sessions) return (sessionList.innerHTML = "<i>No sessions found.</i>");

        Object.entries(sessions).forEach(([name, data]) => {
          let role = "";
          let inSession = false;
          if (data.dm?.id === userId) role = "DM", inSession = true;
          else if (data.approvedPlayers?.[userId]) role = "Player", inSession = true;
          else if (data.pendingPlayers?.[userId]) role = "Pending", inSession = true;

          if (inSession) {
            sessionList.innerHTML += `<div><strong>${name}</strong> (${role}) 
              <button onclick="viewSession('${name}', '${role}')">View</button></div>`;
          }
        });
      });
    }

    window.onload = handleDiscordLogin;
  </script>
</body>
</html>
